<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket Chat</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            background: #f5f5f5;
            height: 100vh;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 500px;
            height: 100%;
            background: white;
            border: 1px solid #ccc;
        }

        .chat-header {
            background: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 70%;
        }

        .sent {
            background: #007bff;
            color: white;
            align-self: flex-end;
        }

        .received {
            background: #e5e5ea;
            color: black;
            align-self: flex-start;
        }

        .chat-input {
            display: flex;
            border-top: 1px solid #ccc;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: none;
        }

        .chat-input button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
        }

        .chat-input button:hover {
            background: #0056b3;
        }

        @media (max-width: 600px) {
            .chat-container {
                border: none;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header position-sticky top-0 clearfix">
            <div class="row">
                <div class="col-lg-6 d-flex align-items-center">
                    <a href="javascript:void(0);" data-toggle="modal" data-target="#view_info">
                        <img src="https://dev.fhd-tech.com/default_images/admin.png" alt="avatar" class="img-fluid rounded-circle" width="50" height="50" id="receiverAvatar">
                    </a>
                    <div class="chat-about">
                        <h5 class="m-b-0 text-capitalize" id="receiverName"> lorem ipsum
                        </h5>
                    </div>
                </div>
            </div>
        </div>
    <div id="messages" class="messages"></div>
    <div id="typingIndicator" style="padding: 5px; font-size: 0.9em; color: gray;"></div>
    <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
    </div>
</div>

<script>
    const socket = io("http://localhost:3000"); // Change port if needed

    // Replace with your actual IDs
    const senderId = prompt("Enter your userId:");
    const receiverId = prompt("Enter receiver's userId:");

    // Register user on socket
    socket.emit("register", senderId);

    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingIndicator = document.getElementById("typingIndicator");

    let typingTimeout;

    socket.on("receiver_info", ({ name, profileImage }) => {
        document.getElementById("receiverName").textContent = name;
        document.getElementById("receiverAvatar").src = profileImage;
    });

    // Load chat history
    socket.emit('load_messages', { senderId, receiverId });

    socket.on("chat_history", (messages) => {
        

        messages.forEach(message => {
            appendMessage(message);
        });
    });


     // Send message
    function sendMessage() {
        const content = messageInput.value.trim();
        if (!content) return;

        socket.emit("private_message", { senderId, receiverId, content });
        messageInput.value = "";
        socket.emit("stop_typing", { senderId, receiverId });
    }
    
    sendBtn.addEventListener("click", sendMessage);

    messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            sendMessage();
        }
    });

    //Type detection
     messageInput.addEventListener("input", () => {
        socket.emit("typing", { senderId, receiverId });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit("stop_typing", { senderId, receiverId });
        }, 5000);
    });

    // For real-time incoming messages
    socket.on("new_message", (message) => {
        appendMessage(message);
    });

    // Receive messages
    function appendMessage(message) {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message");
        if (parseInt(message.senderId) === parseInt(senderId)) {
            msgDiv.classList.add("sent");
        } else {
            msgDiv.classList.add("received");
        }

        
        const timeText = document.createElement("div");
        timeText.style.fontSize = "0.8em";
        timeText.style.color = "#777";
        timeText.textContent = timeAgo(message.createdAt);

        msgDiv.textContent = message.content;
        msgDiv.appendChild(document.createElement("br"));
        msgDiv.appendChild(timeText);

        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Show typing indicator
    socket.on("typing", ({ senderId: typerId }) => {
        if (parseInt(typerId) === parseInt(receiverId)) {
            messageInput.placeholder = "User is typing...";
        }
    });

    socket.on("stop_typing", ({ senderId: typerId }) => {
        if (parseInt(typerId) === parseInt(receiverId)) {
            messageInput.placeholder = "Type a message...";
        }
    });

    // Time formatter
    function timeAgo(date) {
        const now = new Date();
        const messageDate = new Date(date);
        const seconds = Math.floor((now - messageDate) / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (seconds < 60) return "Just now";
        if (minutes < 60) return `${minutes} min${minutes > 1 ? "s" : ""} ago`;
        if (hours < 24) return `${hours} hr${hours > 1 ? "s" : ""} ago`;
        if (days < 7) return `${days} day${days > 1 ? "s" : ""} ago`;
        return messageDate.toLocaleDateString();
    }

      
</script>

</body>
</html>
